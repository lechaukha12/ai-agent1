<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K8s Log Agent Dashboard v1.0.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .stat-card { transition: transform 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); }
        #loading-spinner { border-top-color: #3498db; }
        .dark #loading-spinner { border-top-color: #60a5fa; }
        .chart-container { min-height: 300px; position: relative; }
        #incidents-table th, #incidents-table td { padding: 0.75rem 1rem; }
        #incidents-table tbody tr { cursor: pointer; transition: background-color 0.1s ease-in-out; }
        #incidents-table tbody tr:hover { background-color: rgba(0, 0, 0, 0.03); }
        .dark #incidents-table tbody tr:hover { background-color: rgba(255, 255, 255, 0.05); }
        [x-cloak] { display: none !important; }
        .modal-content { max-height: 80vh; overflow-y: auto; }
        /* Căn chỉnh 5 cột */
        #incidents-table th:nth-child(1), #incidents-table td:nth-child(1) { width: 15%; } /* Thời gian */
        #incidents-table th:nth-child(2), #incidents-table td:nth-child(2) { width: 25%; } /* Pod */
        #incidents-table th:nth-child(3), #incidents-table td:nth-child(3) { width: 15%; } /* Mức độ */
        #incidents-table th:nth-child(4), #incidents-table td:nth-child(4) { width: 25%; } /* Tóm tắt */
        #incidents-table th:nth-child(5), #incidents-table td:nth-child(5) { width: 20%; } /* Lý do */
        #theme-toggle-button svg { width: 1.25rem; height: 1.25rem; }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 md:p-8 transition-colors duration-300">
    <div x-data="{ open: false, incident: {} }" x-show="open" x-cloak
         @open-incident-modal.window="incident = $event.detail; open = true"
         @keydown.escape.window="open = false"
         class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity dark:bg-gray-900 dark:bg-opacity-75" @click="open = false" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div x-show="open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" id="modal-title"> Chi tiết Sự cố #<span x-text="incident?.id ?? 'N/A'"></span></h3>
                            <div class="mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-3 modal-content">
                                <p><strong>Pod:</strong> <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded" x-text="incident?.pod_key ?? 'N/A'"></code></p>
                                <p><strong>Thời gian:</strong> <span x-text="incident?.timestamp ? formatVietnameseDateTime(incident.timestamp) : 'N/A'"></span></p>
                                <p><strong>Mức độ:</strong> <span :class="{ 'font-semibold text-red-600 dark:text-red-400': incident?.severity === 'ERROR' || incident?.severity === 'CRITICAL', 'font-semibold text-yellow-600 dark:text-yellow-400': incident?.severity === 'WARNING', 'text-gray-500 dark:text-gray-400': incident?.severity === 'INFO' || !incident?.severity }" x-text="incident?.severity ?? 'N/A'"></span></p>
                                <p><strong>Lý do phát hiện ban đầu:</strong></p>
                                <pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-xs whitespace-pre-wrap break-words" x-text="incident?.initial_reasons ?? 'N/A'"></pre>
                                <p><strong>Tóm tắt (AI):</strong></p>
                                <pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-xs whitespace-pre-wrap break-words" x-text="incident?.summary ?? 'N/A'"></pre>
                                <p><strong>Log mẫu:</strong></p>
                                <pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-xs whitespace-pre-wrap break-words" x-text="incident?.sample_logs ?? 'N/A'"></pre>
                                <p><strong>Ngữ cảnh K8s:</strong></p>
                                <pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-xs whitespace-pre-wrap break-words" x-text="incident?.k8s_context ?? 'N/A'"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="open = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white dark:bg-gray-600 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"> Đóng </button>
                </div>
            </div>
        </div>
    </div>
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-2">K8s Log Agent Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-400">Theo dõi sự cố và hoạt động của agent.</p>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Đọc dữ liệu từ: <code id="db-path" class="bg-gray-200 dark:bg-gray-700 px-1 rounded">{{ db_path }}</code></p>
            <div class="absolute top-0 right-0 mt-2 mr-2">
                <button id="theme-toggle-button" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 transition-colors duration-200">
                    <svg id="theme-toggle-dark-icon" class="hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM13 17a1 1 0 100-2h-1a1 1 0 100 2h1zm-9-8a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    <svg id="theme-toggle-system-icon" class="hidden" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25"></path></svg>
                </button>
            </div>
        </header>

        <div id="loading-spinner" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-4 border-gray-300 dark:border-gray-600 border-t-4 rounded-full w-12 h-12 animate-spin z-50"></div>
        <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-500 bg-opacity-50 z-40"></div>

        <section class="mb-8">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">Tổng quan</h2>
                <div class="flex space-x-2">
                    <button data-days="1" class="time-range-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg shadow text-sm opacity-75 hover:opacity-100 transition">Hôm nay</button>
                    <button data-days="7" class="time-range-btn bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-1 px-3 rounded-lg shadow text-sm opacity-75 hover:opacity-100 transition">7 ngày</button>
                    <button data-days="30" class="time-range-btn bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-1 px-3 rounded-lg shadow text-sm opacity-75 hover:opacity-100 transition">30 ngày</button>
                </div>
             </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-red-600 dark:text-red-400 mb-2">Tổng Sự Cố</h3>
                    <p id="total-incidents" class="text-4xl font-bold text-red-500 dark:text-red-400">--</p>
                </div>
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-2">Lượt gọi Model</h3>
                    <p id="total-gemini-calls" class="text-4xl font-bold text-blue-500 dark:text-blue-400">--</p>
                </div>
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-green-600 dark:text-green-400 mb-2">Cảnh báo Telegram</h3>
                    <p id="total-telegram-alerts" class="text-4xl font-bold text-green-500 dark:text-green-400">--</p>
                </div>
            </div>
        </section>
        <section class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-8">
             <div class="md:col-span-1">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Top 5 Pod Gây Rối</h2>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 chart-container" id="topPodsChartContainer">
                     <canvas id="topPodsChart"></canvas>
                     <p id="top-pods-error" class="absolute inset-0 flex items-center justify-center text-center text-red-500 hidden p-4">Lỗi tải dữ liệu.</p>
                     <p id="top-pods-no-data" class="absolute inset-0 flex items-center justify-center text-center text-gray-500 dark:text-gray-400 hidden p-4">Không có dữ liệu.</p>
                </div>
            </div>
             <div class="md:col-span-1">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Phân bố Namespace</h2>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 chart-container" id="namespacePieChartContainer">
                     <canvas id="namespacePieChart"></canvas>
                     <p id="namespace-pie-error" class="absolute inset-0 flex items-center justify-center text-center text-red-500 hidden p-4">Lỗi tải dữ liệu.</p>
                     <p id="namespace-pie-no-data" class="absolute inset-0 flex items-center justify-center text-center text-gray-500 dark:text-gray-400 hidden p-4">Không có dữ liệu.</p>
                </div>
            </div>
             <div class="md:col-span-1">
                 <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Phân loại Mức độ (Hôm nay)</h2>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 chart-container" id="severityPieChartContainer">
                     <canvas id="severityPieChart"></canvas>
                     <p id="severity-pie-error" class="absolute inset-0 flex items-center justify-center text-center text-red-500 hidden p-4">Lỗi tải dữ liệu.</p>
                     <p id="severity-pie-no-data" class="absolute inset-0 flex items-center justify-center text-center text-gray-500 dark:text-gray-400 hidden p-4">Không có sự cố hôm nay.</p>
                </div>
            </div>
             </section>
        <section class="mb-8">
             <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Xu hướng hàng ngày</h2>
            <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 chart-container" id="statsChartContainer">
                 <canvas id="statsChart"></canvas>
                 <p id="line-chart-error" class="text-center text-red-500 hidden mt-4">Lỗi tải dữ liệu biểu đồ đường.</p>
                 <p id="line-chart-no-data" class="text-center text-gray-500 dark:text-gray-400 hidden mt-4">Chưa có đủ dữ liệu thống kê hàng ngày để vẽ biểu đồ đường.</p>
            </div>
        </section>

        <section>
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                 <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 flex-shrink-0">Danh sách Sự cố</h2>
                 <div class="flex flex-wrap items-center gap-2 md:gap-4 w-full md:w-auto">
                     <input type="text" id="pod-filter" placeholder="Lọc theo Pod/Namespace..." class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 flex-grow md:flex-grow-0">
                     <select id="severity-filter" class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200">
                         <option value="">Tất cả Mức độ</option>
                         <option value="INFO">INFO</option>
                         <option value="WARNING">WARNING</option>
                         <option value="ERROR">ERROR</option>
                         <option value="CRITICAL">CRITICAL</option>
                     </select>
                     <button id="filter-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1.5 px-4 rounded-lg shadow text-sm transition duration-200 ease-in-out">Lọc</button>
                     <button id="refresh-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-4 rounded-lg shadow text-sm transition duration-200 ease-in-out">Làm mới</button>
                 </div>
                 </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto border border-gray-200 dark:border-gray-700">
                <table id="incidents-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Thời gian</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pod</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Mức độ</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tóm tắt</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lý do phát hiện</th>
                        </tr>
                    </thead>
                    <tbody id="incidents-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
             <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-gray-600 dark:text-gray-400">
                <span id="pagination-info"></span>
                <div class="flex space-x-2">
                    <button id="prev-page" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">&lt; Trước</button>
                    <button id="next-page" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Sau &gt;</button>
                </div>
             </div>
             </section>

    </div>

    <script>
        // === Biến DOM (Giữ nguyên) ===
        const incidentsTableBody = document.getElementById('incidents-table-body');
        const totalIncidentsElem = document.getElementById('total-incidents');
        const totalGeminiCallsElem = document.getElementById('total-gemini-calls');
        const totalTelegramAlertsElem = document.getElementById('total-telegram-alerts');
        const todayDateElem = document.getElementById('today-date');
        const refreshButton = document.getElementById('refresh-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingOverlay = document.getElementById('loading-overlay');
        // Biểu đồ
        const lineChartCtx = document.getElementById('statsChart').getContext('2d');
        const lineChartErrorElem = document.getElementById('line-chart-error');
        const lineChartNoDataElem = document.getElementById('line-chart-no-data');
        let lineChartInstance = null;
        const topPodsCtx = document.getElementById('topPodsChart').getContext('2d');
        const topPodsErrorElem = document.getElementById('top-pods-error');
        const topPodsNoDataElem = document.getElementById('top-pods-no-data');
        let topPodsChartInstance = null;
        const namespacePieCtx = document.getElementById('namespacePieChart').getContext('2d');
        const namespacePieErrorElem = document.getElementById('namespace-pie-error');
        const namespacePieNoDataElem = document.getElementById('namespace-pie-no-data');
        let namespacePieInstance = null;
        const severityPieCtx = document.getElementById('severityPieChart').getContext('2d');
        const severityPieErrorElem = document.getElementById('severity-pie-error');
        const severityPieNoDataElem = document.getElementById('severity-pie-no-data');
        let severityPieInstance = null;
        // Nút theme
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const themeToggleSystemIcon = document.getElementById('theme-toggle-system-icon');
        // Bộ lọc & Phân trang
        const podFilterInput = document.getElementById('pod-filter');
        const severityFilterSelect = document.getElementById('severity-filter');
        const filterButton = document.getElementById('filter-button');
        const paginationControls = document.getElementById('pagination-controls');
        const paginationInfo = document.getElementById('pagination-info');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const timeRangeButtons = document.querySelectorAll('.time-range-btn');

        // === Trạng thái ===
        let currentIncidentPage = 1;
        let totalIncidentPages = 1;
        let currentPodFilter = '';
        let currentSeverityFilter = '';
        let currentStatsDays = 1;
        let currentIncidentStartDate = null;
        let currentIncidentEndDate = null;
        const ALERTING_SEVERITY_LEVELS = ['WARNING', 'ERROR', 'CRITICAL'];


        // === Hàm tiện ích ===
        function showLoading() { loadingSpinner.classList.remove('hidden'); loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingSpinner.classList.add('hidden'); loadingOverlay.classList.add('hidden'); }
        function formatVietnameseDateTime(isoString) { /* Giữ nguyên v5 */
             if (!isoString) return 'N/A';
             try {
                 const dateObj = new Date(isoString);
                 if (isNaN(dateObj.getTime())) { throw new Error(`Invalid date parsed from: ${isoString}`); }
                 const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                 return dateObj.toLocaleString('vi-VN', options);
             } catch (e) { console.error("Error formatting date:", isoString, e); return 'Lỗi định dạng'; }
        }
        function setTodayDate() { /* Giữ nguyên */
             const today = new Date();
             const day = String(today.getDate()).padStart(2, '0');
             const month = String(today.getMonth() + 1).padStart(2, '0');
             const year = today.getFullYear();
             // === SỬA LỖI: Kiểm tra todayDateElem trước khi gán ===
             if (todayDateElem) {
                todayDateElem.textContent = `${day}/${month}/${year}`;
             } else {
                console.error("Element with ID 'today-date' not found.");
             }
             // === KẾT THÚC SỬA LỖI ===
        }

        // === Hàm vẽ biểu đồ ===
        function renderLineChart(dailyStats) { /* Giữ nguyên */
             lineChartErrorElem.classList.add('hidden'); lineChartNoDataElem.classList.add('hidden');
             if (!dailyStats || dailyStats.length < 1) { console.warn("Không đủ dữ liệu hàng ngày để vẽ biểu đồ đường."); lineChartNoDataElem.classList.remove('hidden'); if (lineChartInstance) { lineChartInstance.destroy(); lineChartInstance = null; } return; }
             dailyStats.sort((a, b) => new Date(a.date) - new Date(b.date));
             const labels = dailyStats.map(stat => stat.date);
             const incidentData = dailyStats.map(stat => stat.incident_count);
             const geminiData = dailyStats.map(stat => stat.model_calls);
             const telegramData = dailyStats.map(stat => stat.telegram_alerts);
             const isDarkMode = document.documentElement.classList.contains('dark');
             const gridColor = isDarkMode ? 'rgba(107, 114, 128, 0.5)' : 'rgba(209, 213, 219, 0.5)';
             const textColor = isDarkMode ? 'rgb(229, 231, 235)' : 'rgb(55, 65, 81)';
             const chartData = { labels: labels, datasets: [ { label: 'Sự Cố', data: incidentData, borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.1, fill: true, }, { label: 'Gọi Model', data: geminiData, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.1, fill: true, }, { label: 'Cảnh báo Telegram', data: telegramData, borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.1)', tension: 0.1, fill: true, } ] };
             const chartConfig = { type: 'line', data: chartData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0, color: textColor }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { position: 'top', labels: { color: textColor } }, tooltip: { mode: 'index', intersect: false, } } } };
             if (lineChartInstance) { lineChartInstance.destroy(); }
             lineChartInstance = new Chart(lineChartCtx, chartConfig);
        }
        function renderPieChart(ctx, errorElem, noDataElem, chartInstance, chartData, title) { /* Giữ nguyên */
            errorElem.classList.add('hidden'); noDataElem.classList.add('hidden');
            const labels = Object.keys(chartData); const data = Object.values(chartData);
            const total = data.reduce((sum, value) => sum + value, 0);
            if (labels.length === 0 || total === 0) { console.warn(`Không có dữ liệu cho biểu đồ tròn: ${title}`); noDataElem.classList.remove('hidden'); if (chartInstance) { chartInstance.destroy(); chartInstance = null; } return null; }
             const backgroundColors = [ 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(107, 114, 128, 0.7)', 'rgba(168, 85, 247, 0.7)', 'rgba(236, 72, 153, 0.7)' ];
             const hoverBackgroundColors = [ 'rgba(220, 38, 38, 0.9)', 'rgba(217, 119, 6, 0.9)', 'rgba(37, 99, 235, 0.9)', 'rgba(22, 163, 74, 0.9)', 'rgba(75, 85, 99, 0.9)', 'rgba(147, 51, 234, 0.9)', 'rgba(219, 39, 119, 0.9)' ];
             const pieChartData = { labels: labels, datasets: [{ label: title, data: data, backgroundColor: backgroundColors.slice(0, labels.length), hoverBackgroundColor: hoverBackgroundColors.slice(0, labels.length), hoverOffset: 4 }] };
             const isDarkMode = document.documentElement.classList.contains('dark');
             const textColor = isDarkMode ? 'rgb(229, 231, 235)' : 'rgb(55, 65, 81)';
             const pieChartConfig = { type: 'pie', data: pieChartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } }, title: { display: true, text: title, font: { size: 16 }, color: textColor }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { const total = context.chart.data.datasets[0].data.reduce((sum, value) => sum + value, 0); const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%'; label += `${context.parsed} (${percentage})`; } return label; } } } } } };
             if (chartInstance) { chartInstance.destroy(); }
             return new Chart(ctx, pieChartConfig);
         }
         function renderBarChart(ctx, errorElem, noDataElem, chartInstance, chartData, title) { /* Giữ nguyên */
             errorElem.classList.add('hidden'); noDataElem.classList.add('hidden');
             const labels = Object.keys(chartData); const data = Object.values(chartData);
             if (labels.length === 0) { console.warn(`Không có dữ liệu cho biểu đồ cột: ${title}`); noDataElem.classList.remove('hidden'); if (chartInstance) { chartInstance.destroy(); chartInstance = null; } return null; }
             const isDarkMode = document.documentElement.classList.contains('dark');
             const gridColor = isDarkMode ? 'rgba(107, 114, 128, 0.5)' : 'rgba(209, 213, 219, 0.5)';
             const textColor = isDarkMode ? 'rgb(229, 231, 235)' : 'rgb(55, 65, 81)';
             const backgroundColors = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(107, 114, 128, 0.7)'];
             const hoverBackgroundColors = ['rgba(37, 99, 235, 0.9)', 'rgba(220, 38, 38, 0.9)', 'rgba(217, 119, 6, 0.9)', 'rgba(22, 163, 74, 0.9)', 'rgba(75, 85, 99, 0.9)'];

             const barChartData = { labels: labels, datasets: [{ label: 'Số lượng sự cố', data: data, backgroundColor: backgroundColors.slice(0, labels.length), hoverBackgroundColor: hoverBackgroundColors.slice(0, labels.length), borderWidth: 1 }] };
             const barChartConfig = { type: 'bar', data: barChartData, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { precision: 0, color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: true, text: title, font: { size: 16 }, color: textColor } } } };
             if (chartInstance) { chartInstance.destroy(); }
             return new Chart(ctx, barChartConfig);
        }


        // === Hàm Fetch dữ liệu ===
        async function fetchStats(days = 1) { /* Giữ nguyên */
            currentStatsDays = days;
            try {
                const response = await fetch(`/api/stats?days=${days}`);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const stats = await response.json();
                if (stats.error) { console.error("Error fetching stats:", stats.error); totalIncidentsElem.textContent = 'Lỗi'; totalGeminiCallsElem.textContent = 'Lỗi'; totalTelegramAlertsElem.textContent = 'Lỗi'; lineChartErrorElem.classList.remove('hidden'); lineChartNoDataElem.classList.add('hidden'); if (lineChartInstance) { lineChartInstance.destroy(); lineChartInstance = null; } return; }
                totalIncidentsElem.textContent = stats.totals?.incidents ?? '0';
                totalGeminiCallsElem.textContent = stats.totals?.model_calls ?? '0';
                totalTelegramAlertsElem.textContent = stats.totals?.telegram_alerts ?? '0';
                const chartDays = Math.max(days, 7);
                if (chartDays !== days) {
                     const responseChart = await fetch(`/api/stats?days=${chartDays}`);
                     const statsChart = await responseChart.json();
                     if (!statsChart.error) { renderLineChart(statsChart.daily_stats_for_chart); }
                     else { renderLineChart([]); }
                } else { renderLineChart(stats.daily_stats_for_chart); }
                topPodsChartInstance = renderBarChart(topPodsCtx, topPodsErrorElem, topPodsNoDataElem, topPodsChartInstance, stats.top_problematic_pods || {}, 'Top 5 Pod Gây Rối');
                namespacePieInstance = renderPieChart(namespacePieCtx, namespacePieErrorElem, namespacePieNoDataElem, namespacePieInstance, stats.namespace_distribution || {}, 'Phân bố Namespace');
                if (days === 1) {
                     severityPieInstance = renderPieChart(severityPieCtx, severityPieErrorElem, severityPieNoDataElem, severityPieInstance, stats.severity_distribution_today || {}, 'Phân loại Mức độ (Hôm nay)');
                } else {
                     if(severityPieInstance) { severityPieInstance.destroy(); severityPieInstance = null; }
                     severityPieNoDataElem.textContent = `Xem theo ngày để thấy phân loại mức độ.`;
                     severityPieNoDataElem.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
                totalIncidentsElem.textContent = 'Lỗi'; totalGeminiCallsElem.textContent = 'Lỗi'; totalTelegramAlertsElem.textContent = 'Lỗi';
                lineChartErrorElem.classList.remove('hidden'); lineChartNoDataElem.classList.add('hidden'); if (lineChartInstance) { lineChartInstance.destroy(); lineChartInstance = null; }
                topPodsErrorElem.classList.remove('hidden'); topPodsNoDataElem.classList.add('hidden'); if(topPodsChartInstance) { topPodsChartInstance.destroy(); topPodsChartInstance = null; }
                namespacePieErrorElem.classList.remove('hidden'); namespacePieNoDataElem.classList.add('hidden'); if(namespacePieInstance) { namespacePieInstance.destroy(); namespacePieInstance = null; }
                severityPieErrorElem.classList.remove('hidden'); severityPieNoDataElem.classList.add('hidden'); if(severityPieInstance) { severityPieInstance.destroy(); severityPieInstance = null; }
            }
        }

        // === BẮT ĐẦU SỬA LỖI: Hàm fetchIncidents ===
        async function fetchIncidents(page = 1, podFilter = '', severityFilter = '', startDate = null, endDate = null) {
            showLoading();
            currentIncidentPage = page; currentPodFilter = podFilter; currentSeverityFilter = severityFilter;
            currentIncidentStartDate = startDate; currentIncidentEndDate = endDate;
            podFilterInput.value = podFilter; severityFilterSelect.value = severityFilter;
            incidentsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">Đang tải dữ liệu...</td></tr>`;
            paginationControls.classList.add('hidden');

            try {
                let url = `/api/incidents?limit=20&page=${page}&pod=${encodeURIComponent(podFilter)}&severity=${encodeURIComponent(severityFilter)}`;
                if (startDate) { url += `&start_date=${startDate}`; }
                if (endDate) { url += `&end_date=${endDate}`; }

                const response = await fetch(url);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                if (data.error) { throw new Error(`API Error: ${data.error}`); }

                const incidents = data.incidents;
                const pagination = data.pagination;
                totalIncidentPages = pagination.total_pages;

                incidentsTableBody.innerHTML = '';

                // Bỏ phần tính toán Pie Chart ra khỏi đây

                if (incidents.length === 0) {
                    incidentsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">Không tìm thấy sự cố nào khớp với bộ lọc.</td></tr>`;
                } else {
                    incidents.forEach(incident => {
                        // Bỏ phần xử lý ngày cho Pie Chart

                        const row = document.createElement('tr');
                        row.setAttribute('data-incident-id', incident.id);
                        row.onclick = () => openModal(incident.id); // Dùng onclick chuẩn

                        const severityUpper = incident.severity ? incident.severity.toUpperCase() : '';
                        if (severityUpper === 'ERROR' || severityUpper === 'CRITICAL') { row.classList.add('bg-red-50', 'dark:bg-opacity-10', 'dark:bg-red-900'); }
                        else if (severityUpper === 'WARNING') { row.classList.add('bg-yellow-50', 'dark:bg-opacity-10', 'dark:bg-yellow-900'); }

                        // Hàm tạo cell (Sửa lại v8)
                        const createCell = (text, applyLineClamp = false) => { // Đổi tên tham số
                            const cell = document.createElement('td');
                            cell.className = 'px-4 py-3 text-sm text-gray-700 dark:text-gray-300 align-top'; // Luôn align top

                            const displayValue = (text === null || text === undefined) ? 'N/A' : String(text);

                            // Gán title là nội dung đầy đủ (cho tooltip mặc định của trình duyệt)
                            cell.title = displayValue;
                            // Gán textContent
                            cell.textContent = displayValue;

                            // Thêm class giới hạn dòng nếu cần
                            if (applyLineClamp) {
                                cell.classList.add('line-clamp-2'); // Dùng lại class CSS
                                cell.classList.add('whitespace-normal'); // Cho phép xuống dòng
                            } else {
                                cell.classList.add('whitespace-nowrap'); // Giữ không xuống dòng
                            }
                            return cell;
                        };
                        const createSeverityCell = (text) => {
                            const cell = createCell(text); const upperText = text ? text.toUpperCase() : '';
                            if (upperText === 'ERROR' || upperText === 'CRITICAL') { cell.classList.add('font-semibold', 'text-red-600', 'dark:text-red-400'); }
                            else if (upperText === 'WARNING') { cell.classList.add('font-semibold', 'text-yellow-600', 'dark:text-yellow-400'); }
                            else { cell.classList.add('text-gray-500', 'dark:text-gray-400'); }
                            let contentHTML = text ?? 'N/A';
                            if(ALERTING_SEVERITY_LEVELS.includes(upperText)) {
                                contentHTML += ' <span class="text-xs font-normal text-gray-500 dark:text-gray-400">(đã cảnh báo)</span>';
                            }
                            cell.innerHTML = contentHTML;
                            return cell;
                        };

                        // Thêm các cell vào row
                        row.appendChild(createCell(formatVietnameseDateTime(incident.timestamp)));
                        row.appendChild(createCell(incident.pod_key));
                        row.appendChild(createSeverityCell(incident.severity));
                        row.appendChild(createCell(incident.summary, true)); // Áp dụng line-clamp
                        row.appendChild(createCell(incident.initial_reasons, true)); // Áp dụng line-clamp
                        incidentsTableBody.appendChild(row);
                    });

                    // Bỏ phần vẽ Pie Charts
                }

                // Cập nhật phân trang
                if (totalIncidentPages > 0) {
                     paginationInfo.textContent = `Trang ${pagination.page} / ${totalIncidentPages} (Tổng: ${pagination.total_items})`;
                     prevPageButton.disabled = pagination.page <= 1;
                     nextPageButton.disabled = pagination.page >= totalIncidentPages;
                     paginationControls.classList.remove('hidden');
                } else {
                     paginationControls.classList.add('hidden');
                }

            } catch (error) {
                console.error('Lỗi trong quá trình fetch và xử lý sự cố:', error);
                incidentsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Đã xảy ra lỗi khi tải dữ liệu sự cố: ${error.message}. Vui lòng thử lại hoặc kiểm tra console.</td></tr>`;
                paginationControls.classList.add('hidden');
                // Bỏ phần xử lý lỗi pie chart
            } finally {
                 hideLoading();
            }
        }
         // === KẾT THÚC SỬA LỖI ===

         // === Hàm mở Modal (Sửa lỗi Alpine) ===
         async function openModal(incidentId) {
             showLoading();
             try {
                 const response = await fetch(`/api/incidents/${incidentId}`);
                 if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                 const incidentDetails = await response.json();
                 if (incidentDetails.error) { throw new Error(`API Error: ${incidentDetails.error}`); }
                 // Dùng $dispatch để gửi sự kiện cho Alpine
                 document.dispatchEvent(new CustomEvent('open-incident-modal', { detail: incidentDetails }));
             } catch (error) {
                 console.error("Error fetching incident details:", error);
                 alert(`Không thể tải chi tiết sự cố: ${error.message}`);
             } finally {
                 hideLoading();
             }
         }

        // === Logic Theme Toggle (Giữ nguyên) ===
        function updateThemeIcon(theme) { /* ... */
            themeToggleDarkIcon.classList.add('hidden'); themeToggleLightIcon.classList.add('hidden'); themeToggleSystemIcon.classList.add('hidden');
            if (theme === 'dark') { themeToggleLightIcon.classList.remove('hidden'); } else if (theme === 'light') { themeToggleDarkIcon.classList.remove('hidden'); } else { themeToggleSystemIcon.classList.remove('hidden'); }
         }
        function applyTheme(theme) { /* ... */
             if (theme === 'dark') { document.documentElement.classList.add('dark'); } else if (theme === 'light') { document.documentElement.classList.remove('dark'); } else { localStorage.removeItem('theme'); if (window.matchMedia('(prefers-color-scheme: dark)').matches) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); } theme = 'system'; }
             updateThemeIcon(theme);
             fetchStats(currentStatsDays);
         }
        themeToggleButton.addEventListener('click', () => { /* ... */
            const currentTheme = localStorage.getItem('theme') || 'system'; let nextTheme;
            if (currentTheme === 'light') { nextTheme = 'dark'; } else if (currentTheme === 'dark') { nextTheme = 'system'; } else { nextTheme = 'light'; }
            localStorage.setItem('theme', nextTheme); applyTheme(nextTheme);
         });
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => { /* ... */
            if (!localStorage.getItem('theme') || localStorage.getItem('theme') === 'system') { applyTheme('system'); }
         });


        // === Event Listeners ===
        document.addEventListener('DOMContentLoaded', () => {
            // === SỬA LỖI: Gọi setTodayDate sau khi DOM chắc chắn sẵn sàng ===
            // setTodayDate(); // Tạm thời comment lại để tránh lỗi nếu DOM chưa sẵn sàng hoàn toàn
            const initialTheme = localStorage.getItem('theme') || 'system';
            applyTheme(initialTheme); // Sẽ gọi fetchStats(1)
            // Gọi fetchIncidents với ngày hôm nay
            const today = new Date();
            const startUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate(), 0, 0, 0, 0)).toISOString();
            const endUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate(), 23, 59, 59, 999)).toISOString();
            fetchIncidents(1, '', '', startUTC, endUTC); // Tải incidents của hôm nay
             // Gọi setTodayDate ở đây sau khi mọi thứ đã load
             setTodayDate();
            // === KẾT THÚC SỬA LỖI ===
        });

        refreshButton.addEventListener('click', () => {
             fetchStats(currentStatsDays);
             fetchIncidents(1, '', '', currentIncidentStartDate, currentIncidentEndDate);
             podFilterInput.value = '';
             severityFilterSelect.value = '';
        });

        // Nút Lọc
        filterButton.addEventListener('click', () => {
             fetchIncidents(1, podFilterInput.value, severityFilterSelect.value, currentIncidentStartDate, currentIncidentEndDate);
        });
        podFilterInput.addEventListener('keypress', function (e) {
             if (e.key === 'Enter') { filterButton.click(); }
        });

        // Nút Phân trang
        prevPageButton.addEventListener('click', () => {
            if (currentIncidentPage > 1) { fetchIncidents(currentIncidentPage - 1, currentPodFilter, currentSeverityFilter, currentIncidentStartDate, currentIncidentEndDate); }
        });
        nextPageButton.addEventListener('click', () => {
             if (currentIncidentPage < totalIncidentPages) { fetchIncidents(currentIncidentPage + 1, currentPodFilter, currentSeverityFilter, currentIncidentStartDate, currentIncidentEndDate); }
        });

        // Nút chọn khoảng thời gian Stats và Incidents
        timeRangeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const days = parseInt(button.getAttribute('data-days'));
                fetchStats(days);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - days + 1);
                const startUTC = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate(), 0, 0, 0, 0)).toISOString();
                const endUTC = new Date(Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate(), 23, 59, 59, 999)).toISOString();
                fetchIncidents(1, '', '', startUTC, endUTC);
                timeRangeButtons.forEach(btn => { btn.classList.remove('bg-blue-500', 'text-white'); btn.classList.add('bg-gray-300', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-200'); });
                button.classList.add('bg-blue-500', 'text-white'); button.classList.remove('bg-gray-300', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-200');
            });
        });

    </script>
</body>
</html>
