apiVersion: v1
kind: ConfigMap
metadata:
  name: k8s-log-agent-config
  namespace: kube-observability # ƒê·∫£m b·∫£o namespace n√†y ƒë√∫ng v·ªõi m√¥i tr∆∞·ªùng c·ªßa b·∫°n
data:
  # --- Core Agent & Connection Settings ---
  LOKI_URL: "http://loki-loki-distributed-query-frontend:3100" # !!! THAY TH·∫æ B·∫∞NG URL LOKI C·ª¶A B·∫†N !!!
  DB_PATH: "/data/agent_stats.db" # ƒê∆∞·ªùng d·∫´n t·ªõi file SQLite tr√™n PVC
  LOCAL_GEMINI_ENDPOINT: ""     # Endpoint cho provider 'local' (n·∫øu d√πng)

  # --- Agent Behavior Intervals (Seconds) ---
  STATS_UPDATE_INTERVAL_SECONDS: "300"  # T·∫ßn su·∫•t c·∫≠p nh·∫≠t DB th·ªëng k√™
  NAMESPACE_REFRESH_INTERVAL_SECONDS: "3600" # T·∫ßn su·∫•t l√†m m·ªõi danh s√°ch namespace t·ª´ K8s (1 gi·ªù)
  CONFIG_REFRESH_INTERVAL_SECONDS: "60"   # T·∫ßn su·∫•t ƒë·ªçc l·∫°i c·∫•u h√¨nh t·ª´ DB

  # --- Loki Query Parameters (Defaults/Fallbacks) ---
  # C√°c gi√° tr·ªã n√†y c√≥ th·ªÉ ƒë∆∞·ª£c ghi ƒë√® b·ªüi c√†i ƒë·∫∑t trong Portal n·∫øu ƒë∆∞·ª£c tri·ªÉn khai
  LOKI_SCAN_RANGE_MINUTES: "1"
  LOKI_DETAIL_LOG_RANGE_MINUTES: "30"
  LOKI_QUERY_LIMIT: "500"

  # --- Kubernetes Monitoring Settings (Defaults/Fallbacks) ---
  EXCLUDED_NAMESPACES: "kube-node-lease,kube-public" # Namespace lu√¥n lo·∫°i tr·ª´
  DEFAULT_MONITORED_NAMESPACES: "kube-system,default" # Namespace m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ c·∫•u h√¨nh trong DB

  # --- Default AI Settings (Used ONLY if DB config is unavailable/invalid) ---
  # C√°c c√†i ƒë·∫∑t ch√≠nh cho AI (enable, provider, model, key) ƒë∆∞·ª£c qu·∫£n l√Ω qua Portal
  ENABLE_AI_ANALYSIS: "true"    # Gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng ƒë·ªçc ƒë∆∞·ª£c t·ª´ DB
  AI_PROVIDER: "gemini"         # Gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng ƒë·ªçc ƒë∆∞·ª£c t·ª´ DB
  AI_MODEL_IDENTIFIER: "gemini-1.5-flash" # Gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng ƒë·ªçc ƒë∆∞·ª£c t·ª´ DB

  # --- Templates (Should remain here) ---
  PROMPT_TEMPLATE: |
    Ph√¢n t√≠ch t√¨nh hu·ªëng c·ªßa pod Kubernetes '{namespace}/{pod_name}'.
    **∆Øu ti√™n xem x√©t ng·ªØ c·∫£nh Kubernetes** ƒë∆∞·ª£c cung c·∫•p d∆∞·ªõi ƒë√¢y v√¨ n√≥ c√≥ th·ªÉ l√† l√Ω do ch√≠nh b·∫°n ƒë∆∞·ª£c g·ªçi.
    K·∫øt h·ª£p v·ªõi c√°c d√≤ng log sau ƒë√¢y (n·∫øu c√≥) ƒë·ªÉ ƒë∆∞a ra ph√¢n t√≠ch ƒë·∫ßy ƒë·ªß.

    1.  X√°c ƒë·ªãnh m·ª©c ƒë·ªô nghi√™m tr·ªçng t·ªïng th·ªÉ (ch·ªçn m·ªôt: INFO, WARNING, ERROR, CRITICAL).
    2.  N·∫øu m·ª©c ƒë·ªô nghi√™m tr·ªçng l√† WARNING, ERROR ho·∫∑c CRITICAL:
        a. Cung c·∫•p m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn (1-2 c√¢u) b·∫±ng **ti·∫øng Vi·ªát** gi·∫£i th√≠ch v·∫•n ƒë·ªÅ c·ªët l√µi.
        b. ƒê·ªÅ xu·∫•t **nguy√™n nh√¢n g·ªëc c√≥ th·ªÉ x·∫£y ra** (potential root causes) (ng·∫Øn g·ªçn, d·∫°ng g·∫°ch ƒë·∫ßu d√≤ng n·∫øu c√≥ nhi·ªÅu).
        c. ƒê·ªÅ xu·∫•t c√°c **b∆∞·ªõc kh·∫Øc ph·ª•c s·ª± c·ªë** (suggested troubleshooting steps) (ng·∫Øn g·ªçn, d·∫°ng g·∫°ch ƒë·∫ßu d√≤ng).

    Ng·ªØ c·∫£nh Kubernetes:
    --- START CONTEXT ---
    {k8s_context}
    --- END CONTEXT ---

    C√°c d√≤ng log (c√≥ th·ªÉ kh√¥ng c√≥):
    --- START LOGS ---
    {log_text}
    --- END LOGS ---

    Ch·ªâ tr·∫£ l·ªùi b·∫±ng ƒë·ªãnh d·∫°ng JSON v·ªõi c√°c kh√≥a "severity", "summary", "root_cause", v√† "troubleshooting_steps".
    V√≠ d·ª•:
    {{
      "severity": "CRITICAL",
      "summary": "Pod 'kube-system/oomkill-pod' b·ªã Terminated v·ªõi l√Ω do OOMKilled.",
      "root_cause": "- Gi·ªõi h·∫°n b·ªô nh·ªõ (memory limit) qu√° th·∫•p.\n- ·ª®ng d·ª•ng b·ªã r√≤ r·ªâ b·ªô nh·ªõ (memory leak).",
      "troubleshooting_steps": "- TƒÉng memory limit cho pod.\n- Ph√¢n t√≠ch memory profile c·ªßa ·ª©ng d·ª•ng.\n- Ki·ªÉm tra l·∫°i logic c·∫•p ph√°t/gi·∫£i ph√≥ng b·ªô nh·ªõ trong code."
    }}

  TELEGRAM_ALERT_TEMPLATE: |
    üö® *C·∫£nh b√°o K8s/Log (Pod: {pod_key})* üö®
    *M·ª©c ƒë·ªô:* `{severity}`
    *T√≥m t·∫Øt:* {summary}
    *Nguy√™n nh√¢n g·ªëc c√≥ th·ªÉ:*
    {root_cause}
    *ƒê·ªÅ xu·∫•t kh·∫Øc ph·ª•c:*
    {troubleshooting_steps}
    *L√Ω do ph√°t hi·ªán ban ƒë·∫ßu:* {initial_reasons}
    *Th·ªùi gian ph√°t hi·ªán:* `{alert_time}`
    *Log m·∫´u (n·∫øu c√≥):*
    {sample_logs}

    _Vui l√≤ng ki·ªÉm tra chi ti·∫øt tr√™n dashboard ho·∫∑c Loki/Kubernetes._

  # --- C√°c tham s·ªë ƒë√£ chuy·ªÉn sang Portal/DB (kh√¥ng c·∫ßn ·ªü ƒë√¢y n·ªØa) ---
  # LOKI_SCAN_MIN_LEVEL: "INFO"
  # SCAN_INTERVAL_SECONDS: "30"
  # RESTART_COUNT_THRESHOLD: "5"
  # ALERT_SEVERITY_LEVELS: "INFO,WARNING,ERROR,CRITICAL"
  # ALERT_COOLDOWN_MINUTES: "30"
