apiVersion: v1
kind: ConfigMap
metadata:
  name: k8s-log-agent-config
  namespace: kube-observability # ƒê·∫£m b·∫£o namespace n√†y ƒë√∫ng v·ªõi m√¥i tr∆∞·ªùng c·ªßa b·∫°n
data:
  # --- Loki Configuration ---
  LOKI_URL: "http://loki-loki-distributed-query-frontend.loki.svc.cluster.local:3100" # !!! THAY TH·∫æ B·∫∞NG URL LOKI C·ª¶A B·∫†N !!!
  LOKI_SCAN_RANGE_MINUTES: "1" # Kho·∫£ng th·ªùi gian qu√©t log nhanh (ph√∫t)
  LOKI_DETAIL_LOG_RANGE_MINUTES: "30" # Kho·∫£ng th·ªùi gian l·∫•y log chi ti·∫øt khi ƒëi·ªÅu tra (ph√∫t)
  LOKI_QUERY_LIMIT: "500" # Gi·ªõi h·∫°n s·ªë d√≤ng log khi query chi ti·∫øt
  LOKI_SCAN_MIN_LEVEL: "INFO" # M·ª©c log t·ªëi thi·ªÉu ƒë·ªÉ qu√©t Loki ban ƒë·∫ßu (DEBUG, INFO, WARNING, ERROR, CRITICAL)

  # --- Agent Behavior ---
  SCAN_INTERVAL_SECONDS: "30" # T·∫ßn su·∫•t qu√©t (gi√¢y)
  STATS_UPDATE_INTERVAL_SECONDS: "300" # T·∫ßn su·∫•t c·∫≠p nh·∫≠t DB th·ªëng k√™ (gi√¢y)
  NAMESPACE_REFRESH_INTERVAL_SECONDS: "3600" # T·∫ßn su·∫•t l√†m m·ªõi danh s√°ch namespace t·ª´ K8s (gi√¢y, 1 gi·ªù)

  # --- Kubernetes Monitoring ---
  EXCLUDED_NAMESPACES: "kube-node-lease,kube-public" # C√°c namespace lo·∫°i tr·ª´ kh·ªèi qu√©t
  DEFAULT_MONITORED_NAMESPACES: "kube-system,default" # Namespace m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ c·∫•u h√¨nh trong DB
  RESTART_COUNT_THRESHOLD: "5" # Ng∆∞·ª°ng restart container ƒë·ªÉ coi l√† s·ª± c·ªë

  # --- AI Analysis Configuration ---
  GEMINI_MODEL_NAME: "gemini-1.5-flash" # T√™n model Gemini
  USE_LOCAL_MODEL: "false" # ƒê·∫∑t th√†nh "true" n·∫øu mu·ªën d√πng model local thay v√¨ Gemini API
  LOCAL_GEMINI_ENDPOINT: "" # URL c·ªßa endpoint model local (ch·ªâ c·∫ßn n·∫øu USE_LOCAL_MODEL=true)

  # v1.0.6: Updated Prompt Template
  PROMPT_TEMPLATE: |
    Ph√¢n t√≠ch t√¨nh hu·ªëng c·ªßa pod Kubernetes '{namespace}/{pod_name}'.
    **∆Øu ti√™n xem x√©t ng·ªØ c·∫£nh Kubernetes** ƒë∆∞·ª£c cung c·∫•p d∆∞·ªõi ƒë√¢y v√¨ n√≥ c√≥ th·ªÉ l√† l√Ω do ch√≠nh b·∫°n ƒë∆∞·ª£c g·ªçi.
    K·∫øt h·ª£p v·ªõi c√°c d√≤ng log sau ƒë√¢y (n·∫øu c√≥) ƒë·ªÉ ƒë∆∞a ra ph√¢n t√≠ch ƒë·∫ßy ƒë·ªß.

    1.  X√°c ƒë·ªãnh m·ª©c ƒë·ªô nghi√™m tr·ªçng t·ªïng th·ªÉ (ch·ªçn m·ªôt: INFO, WARNING, ERROR, CRITICAL).
    2.  N·∫øu m·ª©c ƒë·ªô nghi√™m tr·ªçng l√† WARNING, ERROR ho·∫∑c CRITICAL:
        a. Cung c·∫•p m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn (1-2 c√¢u) b·∫±ng **ti·∫øng Vi·ªát** gi·∫£i th√≠ch v·∫•n ƒë·ªÅ c·ªët l√µi.
        b. ƒê·ªÅ xu·∫•t **nguy√™n nh√¢n g·ªëc c√≥ th·ªÉ x·∫£y ra** (potential root causes) (ng·∫Øn g·ªçn, d·∫°ng g·∫°ch ƒë·∫ßu d√≤ng n·∫øu c√≥ nhi·ªÅu).
        c. ƒê·ªÅ xu·∫•t c√°c **b∆∞·ªõc kh·∫Øc ph·ª•c s·ª± c·ªë** (suggested troubleshooting steps) (ng·∫Øn g·ªçn, d·∫°ng g·∫°ch ƒë·∫ßu d√≤ng).

    Ng·ªØ c·∫£nh Kubernetes:
    --- START CONTEXT ---
    {k8s_context}
    --- END CONTEXT ---

    C√°c d√≤ng log (c√≥ th·ªÉ kh√¥ng c√≥):
    --- START LOGS ---
    {log_text}
    --- END LOGS ---

    Ch·ªâ tr·∫£ l·ªùi b·∫±ng ƒë·ªãnh d·∫°ng JSON v·ªõi c√°c kh√≥a "severity", "summary", "root_cause", v√† "troubleshooting_steps".
    V√≠ d·ª•:
    {{
      "severity": "CRITICAL",
      "summary": "Pod 'kube-system/oomkill-pod' b·ªã Terminated v·ªõi l√Ω do OOMKilled.",
      "root_cause": "- Gi·ªõi h·∫°n b·ªô nh·ªõ (memory limit) qu√° th·∫•p.\n- ·ª®ng d·ª•ng b·ªã r√≤ r·ªâ b·ªô nh·ªõ (memory leak).",
      "troubleshooting_steps": "- TƒÉng memory limit cho pod.\n- Ph√¢n t√≠ch memory profile c·ªßa ·ª©ng d·ª•ng.\n- Ki·ªÉm tra l·∫°i logic c·∫•p ph√°t/gi·∫£i ph√≥ng b·ªô nh·ªõ trong code."
    }}

  # --- Alerting Configuration ---
  ALERT_SEVERITY_LEVELS: "INFO,WARNING,ERROR,CRITICAL" # C√°c m·ª©c ƒë·ªô s·∫Ω g·ª≠i c·∫£nh b√°o Telegram

  # v1.0.6: Added configurable Telegram Alert Template
  # C√°c placeholder c√≥ s·∫µn: {pod_key}, {severity}, {summary}, {root_cause}, {troubleshooting_steps}, {initial_reasons}, {alert_time}, {sample_logs}
  TELEGRAM_ALERT_TEMPLATE: |
    üö® *C·∫£nh b√°o K8s/Log (Pod: {pod_key})* üö®
    *M·ª©c ƒë·ªô:* `{severity}`
    *T√≥m t·∫Øt:* {summary}
    *Nguy√™n nh√¢n g·ªëc c√≥ th·ªÉ:*
    {root_cause}
    *ƒê·ªÅ xu·∫•t kh·∫Øc ph·ª•c:*
    {troubleshooting_steps}
    *L√Ω do ph√°t hi·ªán ban ƒë·∫ßu:* {initial_reasons}
    *Th·ªùi gian ph√°t hi·ªán:* `{alert_time}`
    *Log m·∫´u (n·∫øu c√≥):*
    {sample_logs}

    _Vui l√≤ng ki·ªÉm tra chi ti·∫øt tr√™n dashboard ho·∫∑c Loki/Kubernetes._

  # --- Database Path ---
  DB_PATH: "/data/agent_stats.db" # ƒê∆∞·ªùng d·∫´n t·ªõi file SQLite tr√™n PVC

